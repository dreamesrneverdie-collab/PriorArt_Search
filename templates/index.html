{% extends "base.html" %}

{% block title %}Patent Search - Home{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Input Section -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>Patent Search
                    </h3>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="mb-3">
                            <label for="patentDescription" class="form-label">Patent Description</label>
                            <textarea 
                                class="form-control" 
                                id="patentDescription" 
                                name="patent_description"
                                rows="6" 
                                required
                                placeholder="Enter your patent description here..."></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-play me-2"></i>Start Workflow
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Processing...</p>
            </div>

            <!-- Keywords Section -->
            <div id="keywordsSection" class="card shadow mb-4" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">Review Keywords</h4>
                </div>
                <div class="card-body">
                    <div id="keywordGroups">
                        <!-- Keywords will be inserted here -->
                    </div>
                    <div class="mt-4 text-center">
                        <button class="btn btn-success me-2" onclick="handleAccept()">
                            <i class="fas fa-check me-2"></i>Accept
                        </button>
                        <button class="btn btn-danger" onclick="handleReject()">
                            <i class="fas fa-times me-2"></i>Reject
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="card shadow" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">Search Results</h4>
                </div>
                <div class="card-body">
                    <div id="searchResults">
                        <!-- Results will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentThreadId = null;
let currentKeywords = null;

// Handle form submission
document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const description = document.getElementById('patentDescription').value;
    if (!description.trim()) {
        alert('Please enter a patent description');
        return;
    }
    
    // Show loading
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('keywordsSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    
    try {
        const response = await axios.post('/start_search', {
            patent_description: description
        });
        
        if (response.data.status === 'waiting_validation') {
            currentThreadId = response.data.thread_id;
            currentKeywords = response.data.seed_keywords;
            showKeywords(response.data.seed_keywords);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + (error.response?.data?.error || error.message));
    } finally {
        document.getElementById('loadingSection').style.display = 'none';
    }
});

// Display keywords for review
function showKeywords(keywords) {
    const container = document.getElementById('keywordGroups');
    container.innerHTML = '';
    
    const categories = {
        'problem_purpose': 'Problem & Purpose',
        'object_system': 'Object & System',
        'environment_field': 'Environment & Field'
    };
    
    for (const [key, title] of Object.entries(categories)) {
        const keywordList = keywords[key] || [];
        
        const section = document.createElement('div');
        section.className = 'mb-4';
        section.innerHTML = `
            <h5 class="text-primary mb-3">${title}</h5>
            <div class="keyword-group" data-category="${key}">
                ${keywordList.map(keyword => `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="${keyword}">
                        <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="addKeywordField('${key}')">
                <i class="fas fa-plus me-1"></i>Add Keyword
            </button>
        `;
        
        container.appendChild(section);
    }
    
    document.getElementById('keywordsSection').style.display = 'block';
}

// Add new keyword input field
function addKeywordField(category) {
    const container = document.querySelector(`[data-category="${category}"]`);
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-control" placeholder="Enter keyword">
        <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(div);
}

// Collect current keywords
function collectKeywords() {
    const keywords = {
        problem_purpose: [],
        object_system: [],
        environment_field: []
    };
    
    for (const category of Object.keys(keywords)) {
        const inputs = document.querySelectorAll(`[data-category="${category}"] input`);
        keywords[category] = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(value => value.length > 0);
    }
    
    return keywords;
}

// Handle accept button click
async function handleAccept() {
    if (!currentThreadId) return;
    
    const keywords = collectKeywords();
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('keywordsSection').style.display = 'none';
    
    try {
        const response = await axios.post('/validate_keywords', {
            thread_id: currentThreadId,
            action: 'accept',
            keywords: keywords
        });
        
        if (response.data.status === 'complete') {
            showResults(response.data.result);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + (error.response?.data?.error || error.message));
        document.getElementById('keywordsSection').style.display = 'block';
    } finally {
        document.getElementById('loadingSection').style.display = 'none';
    }
}

// Handle reject button click
async function handleReject() {
    if (!currentThreadId) return;
    
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('keywordsSection').style.display = 'none';
    
    try {
        const response = await axios.post('/validate_keywords', {
            thread_id: currentThreadId,
            action: 'reject'
        });
        
        if (response.data.status === 'waiting_validation') {
            currentKeywords = response.data.seed_keywords;
            showKeywords(response.data.seed_keywords);
        } else if (response.data.status === 'complete') {
            showResults(response.data.result);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + (error.response?.data?.error || error.message));
        document.getElementById('keywordsSection').style.display = 'block';
    } finally {
        document.getElementById('loadingSection').style.display = 'none';
    }
}

// Display final results
function showResults(result) {
    const container = document.getElementById('searchResults');
    container.innerHTML = '';
    
    // Display keywords
    if (result.seed_keywords || result.enhanced_keywords) {
        container.innerHTML += `
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Keywords</h5>
                </div>
                <div class="card-body">
                    ${formatKeywords(result.enhanced_keywords || result.seed_keywords)}
                </div>
            </div>
        `;
    }
    
    // Display IPC codes if available
    if (result.ipc_codes) {
        container.innerHTML += `
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">IPC Classifications</h5>
                </div>
                <div class="card-body">
                    ${formatIPCCodes(result.ipc_codes)}
                </div>
            </div>
        `;
    }
    
    // Display search results if available
    if (result.search_results) {
        container.innerHTML += `
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Patents Found</h5>
                </div>
                <div class="card-body">
                    ${formatSearchResults(result.search_results)}
                </div>
            </div>
        `;
    }
    
    document.getElementById('resultsSection').style.display = 'block';
}

// Helper function to format keywords
function formatKeywords(keywords) {
    let html = '<div class="row">';
    for (const [category, words] of Object.entries(keywords)) {
        html += `
            <div class="col-md-4 mb-3">
                <h6>${category.replace('_', ' ').toUpperCase()}</h6>
                <div>
                    ${words.map(word => `
                        <span class="badge bg-primary me-1 mb-1">${word}</span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    html += '</div>';
    return html;
}

// Helper function to format IPC codes
function formatIPCCodes(codes) {
    return codes.map(code => `
        <div class="alert alert-info mb-2">
            ${code}
        </div>
    `).join('');
}

// Helper function to format search results
function formatSearchResults(results) {
    return results.map((result, index) => `
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">${result.title || 'Untitled Patent'}</h5>
                <p class="card-text">${result.abstract || result.description || 'No description available'}</p>
                ${result.link ? `
                    <a href="${result.link}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-external-link-alt me-1"></i>View Patent
                    </a>
                ` : ''}
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}
